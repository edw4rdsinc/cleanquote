<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>CleanQuote - Step 4</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/@tensorflow/tfjs@latest/dist/tf.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@teachablemachine/image@latest/dist/teachablemachine-image.min.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;500;600;700;800&display=swap" rel="stylesheet">
    <!-- Calendly widget CSS -->
    <link href="https://assets.calendly.com/assets/external/widget.css" rel="stylesheet">
    <style>
        body { font-family: 'Poppins', sans-serif; background-color: #F0F2F5; }
        .bg-eggshell-white { background-color: #FAF9F7; }
        .bg-warm-sand { background-color: #D6BFA7; }
        .text-deep-graphite { color: #2E2E2E; }
        .hover\:bg-warm-sand-dark:hover { background-color: #c9a88b; }
        .border-warm-sand { border-color: #D6BFA7; }
        .focus\:ring-warm-sand:focus { --tw-ring-color: #D6BFA7; }
        .bg-muted-sky-light { background-color: #eef2f5; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
        .fade-in { animation: fadeIn 0.6s ease-out forwards; }
        .form-section { opacity: 0; animation: fadeIn 0.5s ease-out forwards; }
        .spinner { border: 4px solid rgba(0,0,0,0.1); width: 36px; height: 36px; border-radius: 50%; border-left-color: #2E2E2E; animation: spin 1s ease infinite; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
        .subscription-option:has(:checked) { border-color: #D6BFA7; background-color: #FAF9F7; box-shadow: 0 4px 6px -1px rgb(0 0 0 / 0.1); }
    </style>
</head>
<body class="flex items-center justify-center min-h-screen p-4">
    <div class="bg-eggshell-white rounded-xl shadow-lg p-6 sm:p-8 w-full max-w-2xl opacity-0 fade-in">
        <div id="main-content">
            <div class="text-center mb-6">
                <img src="images/clean-quote-logo.jpg" alt="CleanQuote Logo" class="w-24 h-24 mx-auto rounded-full">
            </div>
            <h1 id="main-header" class="text-3xl font-bold text-deep-graphite mb-6 text-center">Your Details</h1>
            <div id="form-container">
                <p id="form-intro" class="text-deep-graphite opacity-80 text-center mb-6">You're almost there! Just a couple of details to build your quote.</p>
                <form id="customer-info-form" class="space-y-4 mb-8">
                    <div>
                        <label for="customer-name" class="block text-sm font-medium text-deep-graphite">Full Name</label>
                        <input type="text" id="customer-name" required class="mt-1 w-full p-3 bg-white border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-warm-sand">
                    </div>
                    <div>
                        <label for="email" class="block text-sm font-medium text-deep-graphite">Email Address</label>
                        <input type="email" id="email" required class="mt-1 w-full p-3 bg-white border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-warm-sand">
                    </div>
                    <button type="submit" class="w-full bg-warm-sand text-deep-graphite font-semibold py-3 rounded-lg shadow-md hover:bg-warm-sand-dark transition-colors">Build My Quote</button>
                </form>
            </div>
            <div id="loading-view" class="hidden flex flex-col items-center justify-center space-y-4">
                <div class="spinner"></div>
                <p id="loading-subtext" class="text-sm text-gray-500">Getting started...</p>
            </div>
            <div id="results-view" class="hidden space-y-8">
                <div class="form-section" style="animation-delay: 0.1s;">
                    <h2 class="text-xl font-bold text-deep-graphite mb-3">1. Your Quote</h2>
                    <div id="price-breakdown" class="bg-gray-50 p-4 rounded-lg space-y-2 mb-4 border"></div>
                    <!-- *** MODIFIED: Simplified to a single, centered option *** -->
                    <div id="subscription-options" class="flex justify-center"></div>
                </div>
                <div class="form-section" style="animation-delay: 0.2s;">
                    <h2 class="text-xl font-bold text-deep-graphite mb-3">2. Schedule Your Cleaning</h2>
                    <div id="calendar-container" class="bg-muted-sky-light rounded-lg">
                         <!-- Calendly inline widget begin -->
                        <div class="calendly-inline-widget" data-url="https://calendly.com/d/cs3v-9jb-w2g/bethany-clean-quote-booking" style="min-width:320px;height:630px;"></div>
                        <!-- Calendly inline widget end -->
                    </div>
                </div>
                <div class="form-section" style="animation-delay: 0.3s;">
                    <h2 class="text-xl font-bold text-deep-graphite mb-3">3. Confirm and Pay</h2>
                    <div class="bg-gray-100 p-4 rounded-lg flex justify-between items-center">
                        <span class="text-lg font-semibold text-deep-graphite">Booking Deposit:</span>
                        <span id="deposit-amount" class="text-2xl font-bold text-green-600">$20.00</span>
                    </div>
                </div>
                <button id="book-and-pay-button" disabled class="w-full bg-warm-sand text-deep-graphite font-semibold py-3 rounded-lg shadow-md hover:bg-warm-sand-dark transition-colors disabled:bg-gray-300 disabled:opacity-60 disabled:cursor-not-allowed form-section" style="animation-delay: 0.4s;">Book & Pay $20 Deposit</button>
            </div>
        </div>
    </div>
    <!-- Calendly widget JS -->
    <script type="text/javascript" src="https://assets.calendly.com/assets/external/widget.js" async></script>
    <script>
        document.addEventListener('DOMContentLoaded', () => {
            let cleanQuoteData = {};
            const storedData = sessionStorage.getItem('cleanQuoteData');
            if (storedData) {
                try {
                    cleanQuoteData = JSON.parse(storedData);
                } catch (e) {
                    console.error("Could not parse session data:", e);
                }
            }
            cleanQuoteData.services = cleanQuoteData.services || { isEcoFriendly: false };
            cleanQuoteData.photos = cleanQuoteData.photos || {};
            cleanQuoteData.baseEstimatedTime = cleanQuoteData.baseEstimatedTime || 2;

            const URL = "https://teachablemachine.withgoogle.com/models/AN-JyGm2G/";
            let model, loadingInterval, finalQuote;

            const elements = {
                main: document.getElementById('main-content'),
                header: document.getElementById('main-header'),
                formContainer: document.getElementById('form-container'),
                loading: document.getElementById('loading-view'),
                loadingSubtext: document.getElementById('loading-subtext'),
                results: document.getElementById('results-view'),
                subscriptionOptions: document.getElementById('subscription-options'),
                priceBreakdownEl: document.getElementById('price-breakdown'),
                payButton: document.getElementById('book-and-pay-button'),
            };

            elements.formContainer.addEventListener('submit', async (e) => {
                e.preventDefault();
                cleanQuoteData.customerName = document.getElementById('customer-name').value;
                cleanQuoteData.email = document.getElementById('email').value;
                
                elements.formContainer.classList.add('hidden');
                document.getElementById('form-intro').classList.add('hidden');
                elements.header.textContent = 'Building Your Custom Quote...';
                elements.loading.classList.remove('hidden');
                startLoadingAnimation();

                try {
                    model = await tmImage.load(URL + "model.json", URL + "metadata.json");
                    const scores = await analyzePhotos(cleanQuoteData.photos);
                    cleanQuoteData.cleanlinessScores = scores;
                    
                    finalQuote = calculateFinalQuote();
                    cleanQuoteData.finalQuote = finalQuote;
                    displaySubscriptionOptions();
                    
                    elements.loading.classList.add('hidden');
                    elements.header.textContent = 'Your Quote is Ready!';
                    elements.results.classList.remove('hidden');
                    elements.payButton.disabled = false;

                } catch (error) {
                    console.error("Error during quote generation:", error);
                    elements.main.innerHTML = `<div class="p-4 rounded-lg bg-red-100 text-red-700 text-center"><strong>Oops! Something went wrong.</strong><p>${error.message}</p><p>Please try refreshing the page.</p></div>`;
                } finally {
                    clearInterval(loadingInterval);
                }
            });
            
            const startLoadingAnimation = () => {
                const messages = ["Analyzing images...", "Calculating cleaning time...", "Checking for discounts...", "Finalizing your quote..."];
                let i = 0;
                elements.loadingSubtext.textContent = messages[i];
                loadingInterval = setInterval(() => {
                    i = (i + 1) % messages.length;
                    elements.loadingSubtext.textContent = messages[i];
                }, 2000);
            };

            const analyzePhotos = async (photos) => {
                const scores = {};
                elements.loadingSubtext.textContent = 'Analyzing images (0%)...';
                const photoKeys = Object.keys(photos);
                if (photoKeys.length === 0) return {};

                for (let i = 0; i < photoKeys.length; i++) {
                    const key = photoKeys[i];
                    const img = new Image();
                    img.src = photos[key];
                    await new Promise(resolve => img.onload = resolve);
                    const prediction = await model.predict(img);
                    const dirtyPrediction = prediction.find(p => p.className === "Dirty");
                    scores[key] = dirtyPrediction ? dirtyPrediction.probability : 0;
                    elements.loadingSubtext.textContent = `Analyzing images (${Math.round((i + 1) / photoKeys.length * 100)}%)...`;
                }
                return scores;
            };
            
            const calculateFinalQuote = () => {
                const { baseEstimatedTime, cleanlinessScores, services } = cleanQuoteData;
                let finalTime = baseEstimatedTime;
                
                const basePrice = baseEstimatedTime * 75;
                let surcharge = 0;
                
                const scores = Object.values(cleanlinessScores || {});
                if (scores.length > 0) {
                    const avgProbability = scores.reduce((sum, score) => sum + score, 0) / scores.length;
                    if (avgProbability > 0.6) {
                        surcharge = basePrice * 0.20;
                        finalTime *= 1.20;
                    }
                }
                
                let subtotal = basePrice + surcharge;
                let ecoCharge = 0;

                if (services.isEcoFriendly) {
                    ecoCharge = subtotal * 0.05;
                }
                
                const totalPrice = subtotal + ecoCharge;

                // *** MODIFIED: Simplified the return object ***
                return {
                    basePrice, surcharge, ecoCharge, totalPrice,
                    estimatedTime: finalTime
                };
            };

            const displaySubscriptionOptions = () => {
                // *** MODIFIED: Removed other options and renamed the label ***
                const options = [
                    { id: 'oneTime', label: 'My First Clean', price: finalQuote.totalPrice, checked: true },
                ];
                elements.subscriptionOptions.innerHTML = options.map(opt => `
                    <label for="${opt.id}" class="subscription-option block p-4 border-2 border-gray-200 rounded-lg cursor-pointer transition-colors w-full sm:w-64 text-center">
                        <input type="radio" name="subscription" id="${opt.id}" value="${opt.price}" class="sr-only" ${opt.checked ? 'checked' : ''}>
                        <p class="font-semibold text-deep-graphite">${opt.label}</p>
                        <p class="text-2xl font-bold text-deep-graphite">$${opt.price.toFixed(2)}</p>
                    </label>
                `).join('');
                
                displayPriceBreakdown();
            };
            
            const displayPriceBreakdown = () => {
                const selectedRadio = document.querySelector('input[name="subscription"]:checked');
                if (!selectedRadio) return;

                const selectedPrice = parseFloat(selectedRadio.value);
                cleanQuoteData.finalPrice = selectedPrice;

                // *** MODIFIED: Removed discount logic as it's no longer needed ***
                elements.priceBreakdownEl.innerHTML = `
                    <div class="flex justify-between items-center text-gray-700">
                        <span>Base Cleaning Estimate</span>
                        <span class="font-medium">$${finalQuote.basePrice.toFixed(2)}</span>
                    </div>
                    ${finalQuote.surcharge > 0 ? `
                    <div class="flex justify-between items-center text-gray-700">
                        <span>Extended Service Time</span>
                        <span class="font-medium">+$${finalQuote.surcharge.toFixed(2)}</span>
                    </div>` : ''}
                    ${finalQuote.ecoCharge > 0 ? `
                    <div class="flex justify-between items-center text-gray-700">
                        <span>Eco-Friendly Products</span>
                        <span class="font-medium">+$${finalQuote.ecoCharge.toFixed(2)}</span>
                    </div>` : ''}
                    <div class="flex justify-between items-center text-deep-graphite border-t pt-2 mt-2">
                        <span class="font-bold text-lg">Your Price</span>
                        <span class="font-bold text-lg">$${cleanQuoteData.finalPrice.toFixed(2)}</span>
                    </div>
                `;
            };

            elements.payButton.addEventListener('click', () => {
                sessionStorage.setItem('cleanQuoteData', JSON.stringify(cleanQuoteData));
                window.open('https://buy.stripe.com/fZu7sL2fB1qS1a91Zv2oE00', '_blank');
            });
        });
    </script>
</body>
</html>
