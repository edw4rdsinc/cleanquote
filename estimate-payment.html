<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>EA4-CleanQuote - Step 4</title>
    <!-- Tailwind CSS via CDN -->
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f7fafc;
        }
        .message-box {
            display: none; /* Initially hidden */
        }
        .spinner {
            border: 4px solid rgba(0, 0, 0, 0.1);
            width: 36px;
            height: 36px;
            border-radius: 50%;
            border-left-color: #2563eb; /* blue-600 */
            animation: spin 1s ease infinite;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
    </style>
</head>
<body class="flex items-center justify-center min-h-screen p-4">
    <div class="bg-white rounded-xl shadow-lg p-6 sm:p-8 w-full max-w-xl">
        <h1 class="text-3xl font-bold text-gray-800 mb-6 text-center">Step 4: Generate Estimate</h1>
        
        <p class="text-gray-600 text-center mb-6">
            Analyzing your photos to generate an accurate estimate.
        </p>

        <!-- Loading state -->
        <div id="loading-view" class="flex flex-col items-center justify-center space-y-4">
            <div class="spinner"></div>
            <p class="text-lg text-gray-600 font-medium">Analyzing your photos...</p>
            <p class="text-sm text-gray-500">This may take a moment.</p>
        </div>

        <!-- Quote Preview and Results state -->
        <div id="results-view" class="hidden space-y-6">
            <h2 class="text-2xl font-bold text-gray-800 text-center">Your Quote</h2>
            <div id="scores-container" class="grid grid-cols-2 gap-4">
                <!-- Scores will be dynamically inserted here -->
            </div>
            
            <div class="flex justify-between items-center bg-gray-100 p-4 rounded-lg text-lg font-bold">
                <span>Total Price:</span>
                <span id="total-price" class="text-2xl font-extrabold text-blue-600"></span>
            </div>
            <div class="flex justify-between items-center bg-gray-100 p-4 rounded-lg text-lg font-semibold">
                <span>50% Deposit:</span>
                <span id="deposit-amount" class="text-xl font-bold text-green-600"></span>
            </div>

            <div class="message-box p-4 rounded-lg bg-green-100 text-green-700 text-center">
                Your photos have been analyzed and your estimate is ready!
            </div>

            <button
                id="book-and-pay-button"
                class="w-full bg-blue-600 text-white font-semibold py-3 rounded-lg shadow-md hover:bg-blue-700 transition-colors"
            >
                Book & Pay Deposit
            </button>
        </div>
    </div>

    <!-- Teachable Machine Libraries -->
    <script src="https://cdn.jsdelivr.net/npm/@tensorflow/tfjs@latest/dist/tf.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@teachablemachine/image@latest/dist/teachablemachine-image.min.js"></script>

    <script>
        document.addEventListener('DOMContentLoaded', async () => {
            window.cleanQuote = window.cleanQuote || {};
            
            // --- Teachable Machine Model & Global Data ---
            const URL = "https://teachablemachine.withgoogle.com/models/AN-JyGm2G/";
            let model;

            const cleanlinessDescriptions = {
                1: 'Very Clean',
                2: 'Clean',
                3: 'Average Messiness',
                4: 'Messy',
                5: 'Very Messy'
            };

            const getColorClass = (score) => {
                if (score <= 2) return 'text-green-600';
                if (score === 3) return 'text-yellow-600';
                return 'text-red-600';
            };

            const servicePrices = {
                'Standard Clean': 120,
                'Deep Clean': 60,
                'Inside Fridge': 20,
                'Inside Oven': 20,
                'Windows': 40
            };

            // --- UI Element References ---
            const loadingView = document.getElementById('loading-view');
            const resultsView = document.getElementById('results-view');
            const scoresContainer = document.getElementById('scores-container');
            const totalPriceElement = document.getElementById('total-price');
            const depositAmountElement = document.getElementById('deposit-amount');
            const bookAndPayButton = document.getElementById('book-and-pay-button');

            // --- Main Logic ---
            try {
                // 1. Load the Teachable Machine model
                const modelURL = URL + "model.json";
                const metadataURL = URL + "metadata.json";
                model = await tmImage.load(modelURL, metadataURL);

                // 2. Get the photos from the previous step
                const photos = window.cleanQuote.photos;
                if (!photos || Object.keys(photos).length === 0) {
                    throw new Error("No photos found. Please go back to the photo upload step.");
                }

                // 3. Analyze each photo and get the scores
                const cleanlinessScores = {};
                for (const roomName in photos) {
                    const file = photos[roomName];
                    const image = await createImageBitmap(file);
                    const prediction = await model.predict(image);
                    
                    const highestPrediction = prediction.reduce((prev, current) => (prev.probability > current.probability) ? prev : current);
                    const score = parseInt(highestPrediction.className);
                    cleanlinessScores[roomName] = score;
                }

                window.cleanQuote.cleanlinessScores = cleanlinessScores;
                
                // 4. Calculate and display the quote
                const quote = calculateQuote();
                displayQuote(quote);

                loadingView.classList.add('hidden');
                resultsView.classList.remove('hidden');

            } catch (error) {
                console.error("Error during AI analysis:", error);
                loadingView.innerHTML = `<div class="p-4 mt-4 rounded-lg bg-red-100 text-red-700 text-center">
                                         An error occurred: ${error.message}
                                     </div>`;
            }

            // --- Helper Functions ---
            const calculateQuote = () => {
                const { squareFootage, services, cleanlinessScores } = window.cleanQuote;

                let basePrice = 0;
                let deepCleanSelected = false;
                let addonCount = 0;

                services.forEach(service => {
                    if (service === 'Standard Clean') basePrice += servicePrices['Standard Clean'];
                    if (service === 'Deep Clean') {
                        basePrice += servicePrices['Deep Clean'];
                        deepCleanSelected = true;
                    }
                    if (service !== 'Standard Clean' && service !== 'Deep Clean') {
                        basePrice += servicePrices[service] || 0;
                        addonCount++;
                    }
                });
                
                if (deepCleanSelected && addonCount >= 2) {
                    const discount = basePrice * 0.10;
                    basePrice -= discount;
                }
                
                const scores = Object.values(cleanlinessScores);
                const sumScores = scores.reduce((sum, score) => sum + score, 0);
                const avgScore = sumScores / scores.length;
                
                const cleanlinessSurcharge = (avgScore - 1) * 10 * scores.length;
                const totalPrice = basePrice + cleanlinessSurcharge;

                return {
                    totalPrice: totalPrice,
                    depositAmount: totalPrice / 2,
                };
            };
            
            const displayQuote = (quote) => {
                const { totalPrice, depositAmount } = quote;

                totalPriceElement.textContent = `$${totalPrice.toFixed(2)}`;
                depositAmountElement.textContent = `$${depositAmount.toFixed(2)}`;
                
                for (const room in window.cleanQuote.cleanlinessScores) {
                    const score = window.cleanQuote.cleanlinessScores[room];
                    const description = cleanlinessDescriptions[score] || 'N/A';
                    const colorClass = getColorClass(score);

                    const scoreCard = document.createElement('div');
                    scoreCard.className = 'bg-gray-50 p-4 rounded-lg shadow-sm';
                    scoreCard.innerHTML = `
                        <h3 class="capitalize font-semibold text-lg text-gray-800 mb-1">${room.replace(/([A-Z])/g, ' $1').trim()}</h3>
                        <p class="text-sm text-gray-600">Cleanliness Score: <span class="font-bold ${colorClass}">${score}</span></p>
                        <p class="text-sm text-gray-600">Rating: <span class="font-medium ${colorClass}">${description}</span></p>
                    `;
                    scoresContainer.appendChild(scoreCard);
                }
            };
            
            // --- Event Listeners ---
            bookAndPayButton.addEventListener('click', async () => {
                const quote = calculateQuote();
                const bookingDetails = {
                    name: window.cleanQuote.customerName,
                    email: window.cleanQuote.email,
                    address: window.cleanQuote.address,
                    totalPrice: quote.totalPrice,
                    depositAmount: quote.depositAmount,
                };
                
                // Simulate a POST request to the backend
                try {
                    const response = await fetch('/stripe/create-checkout', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify(bookingDetails),
                    });

                    if (response.ok) {
                        const data = await response.json();
                        // Save booking details and redirect to Stripe
                        window.cleanQuote.bookingDetails = bookingDetails;
                        window.location.href = data.checkout_url;
                    } else {
                        throw new Error('Failed to create a Stripe checkout session.');
                    }
                } catch (error) {
                    console.error('Error with Stripe checkout:', error);
                    alert('There was an error processing your payment. Please try again.');
                }
            });
        });
    </script>
</body>
</html>
