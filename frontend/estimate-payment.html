<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>CleanQuote - Step 4</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/@tensorflow/tfjs@latest/dist/tf.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@teachablemachine/image@latest/dist/teachablemachine-image.min.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;500;600;700;800&display=swap" rel="stylesheet">
    <style>
        body { font-family: 'Poppins', sans-serif; background-color: #F0F2F5; }
        .bg-eggshell-white { background-color: #FAF9F7; }
        .bg-warm-sand { background-color: #D6BFA7; }
        .text-deep-graphite { color: #2E2E2E; }
        .hover\:bg-warm-sand-dark:hover { background-color: #c9a88b; }
        .border-warm-sand { border-color: #D6BFA7; }
        .focus\:ring-warm-sand:focus { --tw-ring-color: #D6BFA7; }
        .bg-muted-sky-light { background-color: #eef2f5; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
        .fade-in { animation: fadeIn 0.6s ease-out forwards; }
        .form-section { opacity: 0; animation: fadeIn 0.5s ease-out forwards; }
        .spinner { border: 4px solid rgba(0,0,0,0.1); width: 36px; height: 36px; border-radius: 50%; border-left-color: #2E2E2E; animation: spin 1s ease infinite; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
        .time-slot { transition: all 0.2s ease-in-out; }
        .time-slot.selected { background-color: #2E2E2E; color: white; font-weight: 600; }
        .subscription-option:has(:checked) { border-color: #D6BFA7; background-color: #FAF9F7; box-shadow: 0 4px 6px -1px rgb(0 0 0 / 0.1); }
    </style>
</head>
<body class="flex items-center justify-center min-h-screen p-4">
    <div class="bg-eggshell-white rounded-xl shadow-lg p-6 sm:p-8 w-full max-w-2xl opacity-0 fade-in">
        <div id="main-content">
            <div class="text-center mb-6">
                <img src="images/clean-quote-logo.jpg" alt="CleanQuote Logo" class="w-24 h-24 mx-auto">
            </div>
            <h1 id="main-header" class="text-3xl font-bold text-deep-graphite mb-6 text-center">Your Details</h1>
            <div id="form-container">
                <p id="form-intro" class="text-deep-graphite opacity-80 text-center mb-6">You're almost there! Just a couple of details to build your quote.</p>
                <form id="customer-info-form" class="space-y-4 mb-8">
                    <div>
                        <label for="customer-name" class="block text-sm font-medium text-deep-graphite">Full Name</label>
                        <input type="text" id="customer-name" required class="mt-1 w-full p-3 bg-white border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-warm-sand">
                    </div>
                    <div>
                        <label for="email" class="block text-sm font-medium text-deep-graphite">Email Address</label>
                        <input type="email" id="email" required class="mt-1 w-full p-3 bg-white border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-warm-sand">
                    </div>
                    <button type="submit" class="w-full bg-warm-sand text-deep-graphite font-semibold py-3 rounded-lg shadow-md hover:bg-warm-sand-dark transition-colors">Build My Quote</button>
                </form>
            </div>
            <div id="loading-view" class="hidden flex-col items-center justify-center space-y-4">
                <div class="spinner"></div>
                <p id="loading-subtext" class="text-sm text-gray-500">Getting started...</p>
            </div>
            <div id="results-view" class="hidden space-y-8">
                <div class="form-section" style="animation-delay: 0.1s;">
                    <h2 class="text-xl font-bold text-deep-graphite mb-3">1. Your Quote & Frequency</h2>
                    <div id="price-breakdown" class="bg-gray-50 p-4 rounded-lg space-y-2 mb-4 border"></div>
                    <div id="subscription-options" class="grid grid-cols-1 sm:grid-cols-3 gap-4"></div>
                </div>
                <div class="form-section" style="animation-delay: 0.2s;">
                    <h2 class="text-xl font-bold text-deep-graphite mb-3">2. Select an Arrival Time</h2>
                    <div id="calendar-container" class="bg-muted-sky-light p-4 rounded-lg"></div>
                </div>
                <div class="form-section" style="animation-delay: 0.3s;">
                    <h2 class="text-xl font-bold text-deep-graphite mb-3">3. Confirm and Pay</h2>
                    <div class="bg-gray-100 p-4 rounded-lg flex justify-between items-center">
                        <span class="text-lg font-semibold text-deep-graphite">50% Deposit Due Today:</span>
                        <span id="deposit-amount" class="text-2xl font-bold text-green-600"></span>
                    </div>
                </div>
                <button id="book-and-pay-button" disabled class="w-full bg-warm-sand text-deep-graphite font-semibold py-3 rounded-lg shadow-md hover:bg-warm-sand-dark transition-colors disabled:bg-muted-sky disabled:opacity-60 disabled:cursor-not-allowed form-section" style="animation-delay: 0.4s;">Book & Pay Deposit</button>
            </div>
        </div>
    </div>
    <script>
        document.addEventListener('DOMContentLoaded', () => {
            // ***FIXED***: Robustly load data from sessionStorage with safe fallbacks for all nested properties.
            let cleanQuoteData = {};
            const storedData = sessionStorage.getItem('cleanQuoteData');
            if (storedData) {
                try {
                    cleanQuoteData = JSON.parse(storedData);
                } catch (e) {
                    console.error("Could not parse session data:", e);
                }
            }
            cleanQuoteData.services = cleanQuoteData.services || { isEcoFriendly: false };
            cleanQuoteData.photos = cleanQuoteData.photos || {};
            cleanQuoteData.baseEstimatedTime = cleanQuoteData.baseEstimatedTime || 2; // Default to 2 hours if missing

            const URL = "https://teachablemachine.withgoogle.com/models/AN-JyGm2G/";
            let model, loadingInterval, finalQuote, selectedTimeSlot;

            const elements = {
                main: document.getElementById('main-content'),
                header: document.getElementById('main-header'),
                formContainer: document.getElementById('form-container'),
                loading: document.getElementById('loading-view'),
                loadingSubtext: document.getElementById('loading-subtext'),
                results: document.getElementById('results-view'),
                subscriptionOptions: document.getElementById('subscription-options'),
                calendarContainer: document.getElementById('calendar-container'),
                priceBreakdownEl: document.getElementById('price-breakdown'),
                depositAmount: document.getElementById('deposit-amount'),
                payButton: document.getElementById('book-and-pay-button'),
            };

            elements.formContainer.addEventListener('submit', async (e) => {
                e.preventDefault();
                cleanQuoteData.customerName = document.getElementById('customer-name').value;
                cleanQuoteData.email = document.getElementById('email').value;
                elements.formContainer.classList.add('hidden');
                elements.header.textContent = 'Building Your Custom Quote...';
                elements.loading.classList.remove('hidden');
                startLoadingAnimation();

                try {
                    model = await tmImage.load(URL + "model.json", URL + "metadata.json");
                    const scores = await analyzePhotos(cleanQuoteData.photos);
                    cleanQuoteData.cleanlinessScores = scores;
                    finalQuote = calculateFinalQuote();
                    cleanQuoteData.finalQuote = finalQuote;
                    displaySubscriptionOptions();
                    await displayCalendar();
                    elements.loading.classList.add('hidden');
                    elements.header.textContent = 'Your Quote is Ready!';
                    elements.results.classList.remove('hidden');
                } catch (error) {
                    elements.main.innerHTML = `<div class="p-4 rounded-lg bg-red-100 text-red-700 text-center">Error: ${error.message}</div>`;
                } finally {
                    clearInterval(loadingInterval);
                }
            });

            const startLoadingAnimation = () => { /* ... (same as before) ... */ };
            const analyzePhotos = async (photos) => { /* ... (same as before) ... */ };
            
            const calculateFinalQuote = () => {
                const { baseEstimatedTime, cleanlinessScores, services } = cleanQuoteData;
                let finalTime = baseEstimatedTime;
                
                const basePrice = baseEstimatedTime * 75;
                let surcharge = 0;
                
                const scores = Object.values(cleanlinessScores || {}); // Use empty object as fallback
                if (scores.length > 0) {
                    const avgScore = scores.reduce((s, c) => s + c, 0) / scores.length;
                    if (avgScore >= 4) {
                        surcharge = basePrice * 0.20;
                        finalTime *= 1.20;
                    }
                }
                
                let subtotal = basePrice + surcharge;
                let ecoCharge = 0;

                if (services.isEcoFriendly) {
                    ecoCharge = subtotal * 0.05;
                }
                
                const totalPrice = subtotal + ecoCharge;

                return {
                    basePrice, surcharge, ecoCharge, totalPrice,
                    oneTime: totalPrice,
                    biWeekly: totalPrice * 0.89,
                    monthly: totalPrice * 0.95,
                    depositAmount: totalPrice / 2,
                    estimatedTime: finalTime
                };
            };

            const displaySubscriptionOptions = () => {
                const options = [
                    { id: 'oneTime', label: 'One-Time Cleaning', price: finalQuote.oneTime, checked: true },
                    { id: 'biWeekly', label: 'Bi-Weekly (Save 11%)', price: finalQuote.biWeekly },
                    { id: 'monthly', label: 'Monthly (Save 5%)', price: finalQuote.monthly }
                ];
                elements.subscriptionOptions.innerHTML = options.map(opt => `
                    <label for="${opt.id}" class="subscription-option block p-4 border-2 border-gray-200 rounded-lg cursor-pointer transition-colors">
                        <input type="radio" name="subscription" id="${opt.id}" value="${opt.price}" class="sr-only" ${opt.checked ? 'checked' : ''}>
                        <p class="font-semibold text-deep-graphite">${opt.label}</p>
                        <p class="text-2xl font-bold text-deep-graphite">$${opt.price.toFixed(2)}</p>
                    </label>
                `).join('');
                updateDeposit();
                elements.subscriptionOptions.addEventListener('change', updateDeposit);
            };

            const updateDeposit = () => {
                const selectedPrice = parseFloat(document.querySelector('input[name="subscription"]:checked').value);
                elements.depositAmount.textContent = `$${(selectedPrice / 2).toFixed(2)}`;
                cleanQuoteData.finalPrice = selectedPrice;
                displayPriceBreakdown();
            };
            
            const displayPriceBreakdown = () => {
                elements.priceBreakdownEl.innerHTML = `
                    <div class="flex justify-between items-center text-gray-700">
                        <span>Base Cleaning Estimate</span>
                        <span class="font-medium">$${finalQuote.basePrice.toFixed(2)}</span>
                    </div>
                    ${finalQuote.surcharge > 0 ? `
                    <div class="flex justify-between items-center text-gray-700">
                        <span>Extended Service Time</span>
                        <span class="font-medium">+$${finalQuote.surcharge.toFixed(2)}</span>
                    </div>` : ''}
                    ${finalQuote.ecoCharge > 0 ? `
                    <div class="flex justify-between items-center text-gray-700">
                        <span>Eco-Friendly Products</span>
                        <span class="font-medium">+$${finalQuote.ecoCharge.toFixed(2)}</span>
                    </div>` : ''}
                    <div class="flex justify-between items-center text-deep-graphite border-t pt-2 mt-2">
                        <span class="font-bold text-lg">Total</span>
                        <span class="font-bold text-lg">$${finalQuote.totalPrice.toFixed(2)}</span>
                    </div>
                `;
            };

            const displayCalendar = async () => { /* ... (same as before) ... */ };
            const handleSlotSelection = (e) => { /* ... (same as before) ... */ };

            elements.payButton.addEventListener('click', async () => {
                elements.payButton.disabled = true;
                elements.payButton.textContent = 'Booking...';
                try {
                    cleanQuoteData.bookingDetails = { startTime: selectedTimeSlot, estimatedHours: finalQuote.estimatedTime };
                    sessionStorage.setItem('cleanQuoteData', JSON.stringify(cleanQuoteData));
                    
                    const stripeRes = await fetch('/stripe/create-checkout', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ depositAmount: cleanQuoteData.finalPrice / 2 }),
                    });
                    if (!stripeRes.ok) throw new Error('Failed to create payment session.');
                    const { checkout_url } = await stripeRes.json();
                    window.location.href = checkout_url;
                } catch (error) {
                    alert(error.message);
                    elements.payButton.disabled = false;
                    elements.payButton.textContent = 'Book & Pay Deposit';
                }
            });
        });
    </script>
</body>
</html>
